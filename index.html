<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hyperbeam Session Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem auto;
      max-width: 600px;
      background: #f6f8fa;
      color: #222;
    }
    .hidden { display: none; }
    .notice { background: #fff8c4; padding: 0.7em 1em; border-radius: 5px; margin-bottom: 1em; }
    #timer-bar {
      background: #e0e0e0;
      border-radius: 5px;
      height: 18px;
      margin-bottom: 1em;
      overflow: hidden;
      width: 100%;
    }
    #timer-progress {
      background: #4caf50;
      height: 100%;
      width: 100%;
      transition: width 1s linear;
    }
    button { margin: 0.5em 0; }
    iframe { width: 100%; height: 400px; border: none; display: block; }
    #status { font-size: 1.1em; margin: 1em 0; }
  </style>
</head>
<body>
  <h1>Hyperbeam Session Demo</h1>
  <div class="notice">
    Sessions auto-terminate after <strong>4 minutes</strong><br>
    If you are inactive for <strong>30 seconds</strong>, your session will end early.
  </div>

  <button id="create-btn">Create Session</button>
  <button id="terminate-btn" class="hidden">Terminate Session</button>
  <div id="timer-bar" class="hidden">
    <div id="timer-progress"></div>
  </div>
  <div id="status"></div>
  <iframe id="hb-frame" class="hidden"></iframe>

  <script>
    let sessionId = null;
    let expiresAt = null;
    let timerInterval = null;
    let pingInterval = null;
    let csrfToken = null;

    async function getCsrfToken() {
      const res = await fetch('/api/vm/csrf-token');
      const json = await res.json();
      csrfToken = json.csrfToken;
    }

    function setStatus(msg, error = false) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.style.color = error ? "#b71c1c" : "#333";
    }

    async function createSession() {
      await getCsrfToken();
      setStatus("Creating session...");
      const res = await fetch('/api/vm', {
        method: "POST",
        headers: {
          "x-csrf-token": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({})
      });
      const data = await res.json();
      if (!res.ok) {
        setStatus("Error: " + (data.error || "Unknown error"), true);
        return;
      }
      sessionId = data.id;
      expiresAt = data.expiresAt;
      document.getElementById('hb-frame').src = data.url;
      document.getElementById('hb-frame').classList.remove('hidden');
      document.getElementById('terminate-btn').classList.remove('hidden');
      document.getElementById('timer-bar').classList.remove('hidden');
      document.getElementById('create-btn').classList.add('hidden');
      setStatus("Session started! Expires in 4 minutes or after 30s inactivity.");
      startTimer();
      startPing();
    }

    function startTimer() {
      const bar = document.getElementById('timer-progress');
      function update() {
        const now = Date.now();
        const remaining = Math.max(0, expiresAt - now);
        const percent = Math.max(0, (remaining / (4 * 60 * 1000)) * 100);
        bar.style.width = percent + "%";
        if (remaining <= 0) {
          setStatus("Session expired.");
          cleanupSession();
        }
      }
      update();
      timerInterval = setInterval(update, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      document.getElementById('timer-bar').classList.add('hidden');
    }

    function startPing() {
      pingInterval = setInterval(() => {
        fetch('/api/vm', {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId })
        });
      }, 10000); // every 10s
    }

    function stopPing() {
      clearInterval(pingInterval);
    }

    async function terminateSession() {
      await getCsrfToken();
      const res = await fetch('/api/vm', {
        method: "DELETE",
        headers: {
          "x-csrf-token": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ sessionId })
      });
      const data = await res.json();
      if (res.ok) {
        setStatus("Session terminated.");
      } else {
        setStatus("Error terminating session: " + (data.error || "Unknown error"), true);
      }
      cleanupSession();
    }

    function cleanupSession() {
      stopPing();
      stopTimer();
      document.getElementById('hb-frame').src = '';
      document.getElementById('hb-frame').classList.add('hidden');
      document.getElementById('terminate-btn').classList.add('hidden');
      document.getElementById('create-btn').classList.remove('hidden');
      sessionId = null;
      expiresAt = null;
    }

    document.getElementById('create-btn').onclick = createSession;
    document.getElementById('terminate-btn').onclick = terminateSession;

    // Optionally, warn on inactivity (no UI, just backend auto-terminates)
  </script>
</body>
</html>